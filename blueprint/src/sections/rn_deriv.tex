\chapter{Radon-Nikodym derivatives and disintegration}


\section{Kernel Radon-Nikodym derivative}


\begin{definition}
  \label{def:kernel_rnDeriv}
  \lean{ProbabilityTheory.Kernel.rnDeriv}
  \leanok
  \uses{lem:kernel_properties}
  Let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels, with either $\mathcal X$ countable or $\mathcal{Y}$ countably generated. The Radon-Nikodym derivative of $\kappa$ with respect to $\eta$, denoted by $\frac{d \kappa}{d \eta}$, is a measurable function $\mathcal X \times \mathcal Y \to \mathbb{R}_{+, \infty}$ with $\kappa = \frac{d \kappa}{d \eta} \cdot \eta + \kappa_{\perp \eta}$, where for all $x$, $\kappa_{\perp \eta}(x) \perp \eta(x)$.
\end{definition}


\begin{lemma}
  \label{lem:rnDeriv_unique}
  \lean{ProbabilityTheory.Kernel.eq_rnDeriv_measure}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels, with either $\mathcal X$ countable or $\mathcal{Y}$ countably generated. If for some $f$ and $\xi$, $\kappa = f \cdot \eta + \xi$ with $\xi(x) \perp \eta(x)$ for all $x$, then for all $x$, $f(x, y) = \frac{d \kappa(x)}{d \eta(x)}(y)$ for $\eta(x)$-almost all $y \in \mathcal Y$.
\end{lemma}

\begin{proof} \leanok
Let $f$ and $\xi$ be such that $\kappa = f \cdot \eta + \xi$ with $\xi(x) \perp \eta(x)$ for all $x$. Then for all $x \in \mathcal X$, $\kappa(x) = f(x, \cdot) \cdot \eta(x) + \xi(x)$ with $\xi(x) \perp \eta(x)$. By the uniqueness result for the Radon-Nikodym derivative of measures, $f(x, \cdot) = \frac{d \kappa(x)}{d \eta(x)}$ almost everywhere.
\end{proof}


\begin{corollary}
  \label{cor:rnDeriv_value}
  \lean{ProbabilityTheory.Kernel.rnDeriv_eq_rnDeriv_measure}
  \leanok
  \uses{def:kernel_rnDeriv}
  For all $x \in \mathcal X$, for $\eta(x)$-almost all $y \in \mathcal Y$, $\frac{d \kappa}{d \eta}(x, y) = \frac{d \kappa(x)}{d \eta(x)}(y)$.
\end{corollary}

\begin{proof} \leanok
\uses{lem:rnDeriv_unique}
Apply Lemma~\ref{lem:rnDeriv_unique}.
\end{proof}



\section{Composition-product}


\begin{lemma}
  \label{lem:ac_compProd_iff}
  \lean{MeasureTheory.Measure.absolutelyContinuous_compProd_of_compProd,MeasureTheory.Measure.absolutelyContinuous_compProd_of_compProd',MeasureTheory.Measure.absolutelyContinuous_of_compProd}
  \leanok
  \uses{lem:kernel_properties}
  Let $\mu, \nu$ be two $\sigma$-finite measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two s-finite kernels. Then
  \begin{itemize}
    \item[(1a)] if $\mu \otimes \kappa \ll \nu \otimes \eta$ then $\mu \otimes \kappa \ll \mu \otimes \eta$,
    \item[(1b)] if $\mu \otimes \kappa \ll \nu \otimes \eta$ and $\kappa(x) \ne 0$ for all $x$ then $\mu \ll \nu$,
    \item[(2)]  if $\mu \ll \nu$ and $\mu \otimes \kappa \ll \mu \otimes \eta$ then $\mu \otimes \kappa \ll \nu \otimes \eta$.
  \end{itemize}
  In particular, if $\kappa(x) \ne 0$ for all $x$ then
  \begin{align*}
  \mu \otimes \kappa \ll \nu \otimes \eta
  \iff \left( \mu \ll \eta \ \wedge \ \mu \otimes \kappa \ll \mu \otimes \eta \right)
  \: .
  \end{align*}
\end{lemma}

\begin{proof}\leanok
\uses{lem:kernel_properties}

\end{proof}


\begin{lemma}
  \label{lem:rnDeriv_eq_ac_left}
  \lean{ProbabilityTheory.Kernel.todo}
  \leanok
  \uses{}
  Let $\mu, \nu$ be two finite measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels.
  Let $\mu' = \left(\frac{\partial \mu}{\partial \nu}\right) \cdot \nu$.
  Then for $(\nu \otimes \eta)$-almost all $z$, $\frac{d (\mu' \otimes \kappa)}{d (\nu \otimes \eta)}(z) = \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)}(z)$.
\end{lemma}

\begin{proof} \leanok
\uses{lem:kernel_properties}
\end{proof}


\begin{lemma}
  \label{cor:rnDeriv_compProd_left}
  \lean{ProbabilityTheory.Kernel.rnDeriv_measure_compProd_left}
  \leanok
  \uses{}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ and let $\kappa : \mathcal X \rightsquigarrow \mathcal Y$ be a finite kernel. Then for $(\nu \otimes \kappa)$-almost all $(x, y)$, $\frac{d (\mu \otimes \kappa)}{d (\nu \otimes \kappa)}(x,y) = \frac{d\mu}{d\nu}(x)$.
\end{lemma}

\begin{proof} \leanok
\uses{}
We can suppose $\mu \ll \nu$ without loss of generality (by Lemma~\ref{lem:rnDeriv_eq_ac_left}).
It suffices to show that the integrals of the two functions agree on all sets in the $\pi$-system of products of measurable sets. Let $s, t$ be two measurable sets of $\mathcal X$ and $\mathcal Y$ respectively.
\begin{align*}
\int_{p \in s \times t} \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \kappa)}(p) \partial(\nu \otimes \kappa)
&= (\mu \otimes \kappa) (s \times t)
\: .
\end{align*}

\begin{align*}
\int_{p \in s \times t} \frac{d \mu}{d \nu}(p_1) \partial(\nu \otimes \kappa)
&= \int_{x \in s} \int_{y \in t} \frac{d \mu}{d \nu}(x) \partial \kappa(x) \partial \nu
\\
&= \int_{x \in s} \frac{d \mu}{d \nu}(x) \kappa(x)(t) \partial \nu
\\
&= \int_{x \in s} \kappa(x)(t) \partial \mu
\\
&= (\mu \otimes \kappa) (s \times t)
\: .
\end{align*}
\end{proof}


\begin{lemma}
  \label{lem:rnDeriv_chain}
  \lean{MeasureTheory.Measure.rnDeriv_mul_rnDeriv,MeasureTheory.Measure.rnDeriv_mul_rnDeriv'}
  \leanok
  \uses{}
  Let $\mu, \nu, \xi$ be $\sigma$-finite measures on $\mathcal X$.
  \begin{enumerate}
    \item If $\mu \ll \nu$ then $\xi$-almost surely, $\frac{d \mu}{d \xi} = \frac{d \mu}{d \nu} \frac{d \nu}{d \xi}$.
    \item If $\nu \ll \xi$ then $\nu$-almost surely, $\frac{d \mu}{d \xi} = \frac{d \mu}{d \nu} \frac{d \nu}{d \xi}$.
  \end{enumerate}
\end{lemma}

\begin{proof}\leanok
\uses{}
\end{proof}


\begin{theorem}[Chain rule for Radon-Nikodym derivatives]
  \label{thm:rnDeriv_chain_compProd}
  \lean{ProbabilityTheory.rnDeriv_compProd}
  \leanok
  \uses{}
  Let $\mu, \nu$ be two finite measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels with $\mu \otimes \kappa \ll \mu \otimes \eta$. Then for $(\nu \otimes \eta)$-almost all $(x,y)$,
  \begin{align*}
  \frac{d(\mu \otimes \kappa)}{d(\nu \otimes \eta)}(x, y)
  = \frac{d \mu}{d \nu}(x) \frac{d(\mu \otimes \kappa)}{d(\mu \otimes \eta)}(x, y)
  \: .
  \end{align*}
\end{theorem}

\begin{proof}\leanok
\uses{lem:rnDeriv_chain,cor:rnDeriv_compProd_left}
By the first point of Lemma~\ref{lem:rnDeriv_chain}, $(\nu \otimes \eta)$-almost surely,
\begin{align*}
\frac{d(\mu \otimes \kappa)}{d(\nu \otimes \eta)}
  = \frac{d(\mu \otimes \kappa)}{d(\mu \otimes \eta)} \frac{d (\mu \otimes \eta)}{d (\nu \otimes \eta)} 
\end{align*}
Then, by Lemma~\ref{cor:rnDeriv_compProd_left}, $\frac{d (\mu \otimes \eta)}{d (\nu \otimes \eta)}$ is almost everywhere equal to $\frac{d\mu}{d\nu}$.
\end{proof}


\begin{lemma}
  \label{lem:rnDeriv_compProd_right_of_ac}
  %\lean{}
  %\leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu \in \mathcal M(\mathcal X)$ and $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels with $\kappa(x) \ll \eta(x)$ for $\mu$-almost all $x$, with either $\mathcal X$ countable or $\mathcal{Y}$ countably generated.
  Then $(\mu \otimes \eta)$-almost surely,
  \begin{align*}
  \frac{d (\mu \otimes \kappa)}{d (\mu \otimes \eta)} = \frac{d \kappa}{d \eta}
  \: .
  \end{align*}
\end{lemma}

\begin{proof}%\leanok
\uses{}

\end{proof}


\begin{lemma}
  \label{lem:ae_rnDeriv_ne_zero}
  \lean{MeasureTheory.Measure.ae_rnDeriv_ne_zero_imp_of_ae}
  \leanok
  \uses{}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ be two $\sigma$-finite measures and let $p$ be a predicate on $\mathcal X$.
  If $p$ is true $\mu$-almost surely, then for $\nu$-almost all $x$, either $\frac{d\mu}{d\nu}(x) = 0$ or $p(x)$.
\end{lemma}

\begin{proof}\leanok
\uses{}

\end{proof}


\begin{lemma}
  \label{lem:rnDeriv_compProd_aux}
  \lean{ProbabilityTheory.Kernel.rnDeriv_measure_compProd_aux}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu, \nu$ be two finite measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels with $\kappa(x) \ll \eta(x)$ for $\mu$-almost all $x$, with either $\mathcal X$ countable or $\mathcal{Y}$ countably generated.
  Then for $(\nu \otimes \eta)$-almost all $(x, y)$,
  \begin{align*}
  \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)}(x,y) = \frac{d\mu}{d\nu}(x)\frac{d \kappa}{d \eta}(x,y)
  \: .
  \end{align*}
  This implies that the equality is true for $\nu$-almost all $x$, for $\eta(x)$-almost all $y$.
\end{lemma}

\begin{proof} \leanok
\uses{cor:rnDeriv_value}
First, by Theorem~\ref{thm:rnDeriv_chain_compProd}, for $(\nu \otimes \eta)$-almost all $(x,y)$,
\begin{align*}
\frac{d(\mu \otimes \kappa)}{d(\nu \otimes \eta)}(x, y)
= \frac{d \mu}{d \nu}(x) \frac{d(\mu \otimes \kappa)}{d(\mu \otimes \eta)}(x, y)
\: .
\end{align*}
It remains to show that $\frac{d \mu}{d \nu}(x) \frac{d(\mu \otimes \kappa)}{d(\mu \otimes \eta)}(x, y)$ is $(\nu \otimes \eta)$-almost everywhere equal to $\frac{d\mu}{d\nu}(x)\frac{d \kappa}{d \eta}(x,y)$.
By Lemma~\ref{lem:rnDeriv_compProd_right_of_ac}, $(\mu \otimes \eta)$-almost surely,
\begin{align*}
\frac{d \kappa}{d \eta} = \frac{d (\mu \otimes \kappa)}{d (\mu \otimes \eta)}
\: .
\end{align*}
We then use Lemma~\ref{lem:ae_rnDeriv_ne_zero} to turn that into a $(\nu \otimes \eta)$-almost sure equality:
\begin{align*}
\frac{d(\mu \otimes \eta)}{d(\nu \otimes \eta)}\frac{d \kappa}{d \eta} = \frac{d(\mu \otimes \eta)}{d(\nu \otimes \eta)}\frac{d (\mu \otimes \kappa)}{d (\mu \otimes \eta)}
\: .
\end{align*}
Finally, by Lemma~\ref{cor:rnDeriv_compProd_left}, $\frac{d(\mu \otimes \eta)}{d(\nu \otimes \eta)} = \frac{d\mu}{d\nu}$ almost surely.
\end{proof}


\begin{lemma}
  \label{lem:rnDeriv_eq_ac}
  \lean{ProbabilityTheory.Kernel.todo1}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu, \nu$ be two measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels, with either $\mathcal X$ countable or $\mathcal{Y}$ countably generated.
  Let $\mu' = \left(\frac{\partial \mu}{\partial \nu}\right) \cdot \nu$ and $\kappa' = \left(\frac{\partial \kappa}{\partial \eta}\right) \cdot \eta$.
  Then for $(\nu \otimes \eta)$-almost all $z$, $\frac{\partial(\mu' \otimes \kappa')}{\partial (\nu \otimes \eta)}(z) = \frac{\partial(\mu \otimes \kappa)}{\partial (\nu \otimes \eta)}(z)$.
\end{lemma}

\begin{proof} \leanok
\end{proof}


\begin{lemma}
  \label{lem:prod_rnDeriv_eq_ac}
  \lean{ProbabilityTheory.Kernel.todo2}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu, \nu$ be two measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels, with either $\mathcal X$ countable or $\mathcal{Y}$ countably generated.
  Let $\mu' = \left(\frac{d \mu}{d \nu}\right) \cdot \nu$ and $\kappa' = \left(\frac{d \kappa}{d \eta}\right) \cdot \eta$. Then for $(\nu \otimes \eta)$-almost all $(x, y)$, $\frac{d\mu'}{d\nu}(x)\frac{d \kappa'}{d \eta}(x,y) = \frac{d\mu}{d\nu}(x)\frac{d \kappa}{d \eta}(x,y)$.
\end{lemma}

\begin{proof} \leanok
\end{proof}


\begin{lemma}
  \label{lem:rnDeriv_compProd}
  \lean{ProbabilityTheory.Kernel.rnDeriv_measure_compProd}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu, \nu$ be two measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels, with either $\mathcal X$ countable or $\mathcal{Y}$ countably generated.
  Then for $(\nu \otimes \eta)$-almost all $(x, y)$, $\frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)}(x,y) = \frac{d\mu}{d\nu}(x)\frac{d \kappa}{d \eta}(x,y)$.
  This implies that the equality is true for $\nu$-almost all $x$, for $\eta(x)$-almost all $y$.
\end{lemma}

\begin{proof} \leanok
\uses{lem:rnDeriv_compProd_aux, lem:rnDeriv_eq_ac, lem:prod_rnDeriv_eq_ac}
Use Lemma~\ref{lem:rnDeriv_eq_ac} for $\mu', \kappa'$ (defined in previous lemmas) then \ref{lem:rnDeriv_compProd_aux} and \ref{lem:prod_rnDeriv_eq_ac}.
\end{proof}


\begin{corollary}
  \label{cor:rnDeriv_compProd_right}
  \lean{ProbabilityTheory.Kernel.rnDeriv_measure_compProd_right}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu$ be a measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels, with either $\mathcal X$ countable or $\mathcal{Y}$ countably generated.
  Then for $(\mu \otimes \eta)$-almost all $(x, y)$, $\frac{d (\mu \otimes \kappa)}{d (\mu \otimes \eta)}(x,y) = \frac{d \kappa}{d \eta}(x,y)$.
\end{corollary}

\begin{proof} \leanok
\uses{lem:rnDeriv_compProd}
\end{proof}



\section{Composition}


\begin{lemma}
  \label{lem:rnDeriv_map_eq_condexp}
  \lean{MeasureTheory.Measure.toReal_rnDeriv_map}
  \leanok
  \uses{}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ with $\mu \ll \nu$, $g : \mathcal X \to \mathcal Y$ a measurable function and denote by $g^* \mathcal Y$ the comap of the $\sigma$-algebra on $\mathcal Y$ by $g$.
  Then $\nu$-almost everywhere,
  \begin{align*}
  \frac{d g_*\mu}{d g_*\nu}(g(x)) = \nu\left[ \frac{d \mu}{d \nu} \mid g^* \mathcal Y\right](x)
  \: .
  \end{align*}
\end{lemma}

\begin{proof}\leanok
\uses{}
We show that the integrals of the two functions agree on all $g^* \mathcal Y$-measurable sets. It suffices to show equality on all sets oc $\mathcal X$ of the form $g^{-1}(t)$ for $t$ a measurable set of $\mathcal Y$.
TODO: also show measurability.
\begin{align*}
\int_{x \in g^{-1}(t)}\frac{d g_*\mu}{d g_*\nu}(g(x)) \partial\nu
&= \int_{y \in t}\frac{d g_*\mu}{d g_*\nu}(y) \partial(g_*\nu)
\\
&= g_*\mu (t)
\: .
\end{align*}

\begin{align*}
\int_{x \in g^{-1}(t)}\nu\left[ \frac{d \mu}{d \nu} \mid g^* \mathcal Y\right](x) \partial\nu
&= \int_{x \in g^{-1}(t)}\frac{d \mu}{d \nu}(x) \partial\nu
\\
&= \mu(g^{-1}(t))
\\
&= g_*\mu(t)
\: .
\end{align*}


\end{proof}


\begin{lemma}
  \label{lem:rnDeriv_comp_eq_condexp}
  \lean{ProbabilityTheory.toReal_rnDeriv_comp_eq_condexp_compProd}
  \leanok
  \uses{}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ with $\mu \ll \nu$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be finite kernels with $\kappa(x) \ll \eta(x)$ $\nu$-a.e..
  Let $\mathcal B$ be the sigma-algebra on $\mathcal X \times \mathcal Y$ obtained by taking the comap of the sigma-algebra of $\mathcal Y$ by the projection.
  Then for $(\nu \otimes \eta)$-almost every $(x,y)$,
  \begin{align*}
  \frac{d(\kappa \circ \mu)}{d(\eta \circ \nu)}(y)
  &= (\nu \otimes \eta)\left[ \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)} \mid \mathcal B \right](x,y)
  \: .
  \end{align*}
\end{lemma}

\begin{proof}\leanok
\uses{lem:rnDeriv_map_eq_condexp}
Let $\pi_Y : \mathcal X \times \mathcal Y \to \mathcal Y$ be the projection $\pi_Y(x,y) = y$.
Remark that $\kappa \circ \mu = \pi_{Y*}(\mu \otimes \kappa)$ and similarly for $\nu, \eta$.
By Lemma~\ref{lem:rnDeriv_map_eq_condexp}, $(\nu \otimes \eta)$-almost everywhere,
\begin{align*}
\frac{d(\kappa \circ \mu)}{d(\eta \circ \nu)}(y)
&= \frac{d \pi_{Y*}(\mu \otimes \kappa)}{d \pi_{Y*}(\nu \otimes \eta)}(\pi_Y((x,y)))
\\
&= (\nu \otimes \eta)\left[ \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)} \mid \mathcal B\right](x,y)
\: .
\end{align*}
\end{proof}


\begin{lemma}[\cite{csiszar1963informationstheoretische}]
  \label{lem:rnDeriv_comp_eq_condexp_right}
  \lean{ProbabilityTheory.toReal_rnDeriv_comp}
  \leanok
  \uses{}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ with $\mu \ll \nu$ and let $\kappa : \mathcal X \rightsquigarrow \mathcal Y$ be a finite kernel.
  Let $\mathcal B$ be the sigma-algebra on $\mathcal X \times \mathcal Y$ obtained by taking the comap of the sigma-algebra of $\mathcal Y$ by the projection.
  Then for $(\nu \otimes \kappa)$-almost every $(x,y)$,
  \begin{align*}
  \frac{d(\kappa \circ \mu)}{d(\kappa \circ \nu)}(y)
  &= (\nu \otimes \kappa)\left[ (x, y) \mapsto \frac{d \mu}{d \nu}(x) \mid \mathcal B \right](x,y)
  \: .
  \end{align*}
  
\end{lemma}

\begin{proof}\leanok
\uses{lem:rnDeriv_comp_eq_condexp,cor:rnDeriv_compProd_left}
Apply Lemma~\ref{lem:rnDeriv_comp_eq_condexp} to get, $(\nu \otimes \kappa)$-almost everywhere,
\begin{align*}
\frac{d(\kappa \circ \mu)}{d(\kappa \circ \nu)}(y)
&= (\nu \otimes \kappa)\left[ \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \kappa)} \mid \mathcal B\right](x,y)
\: .
\end{align*}
Finally, by Corollary~\ref{cor:rnDeriv_compProd_left}, $\frac{d (\mu \otimes \kappa)}{d (\nu \otimes \kappa)} = \frac{d \mu}{d \nu}$ a.e.
\end{proof}


\section{Sigma-algebras}

For $\mathcal A$ a sub-$\sigma$-algebra and $\mu$ a measure, we write $\mathcal \mu_{| \mathcal A}$ for the measure restricted to the $\sigma$-algebra.

\begin{lemma}
  \label{lem:rnDeriv_trim_of_ac}
  \lean{MeasureTheory.Measure.toReal_rnDeriv_trim_of_ac}
  \leanok
  %\uses{}
  Let $\mu, \nu$ be two finite measures on $\mathcal X$ with $\mu \ll \nu$ and let $\mathcal A$ be a sub-$\sigma$-algebra of $\mathcal X$.
  Then $\frac{d \mu_{| \mathcal A}}{d \nu_{| \mathcal A}}$ is $\nu_{| \mathcal A}$-almost everywhere (hence also $\nu$-a.e.) equal to $\nu\left[ \frac{d \mu}{d \nu} \mid \mathcal A\right]$.
\end{lemma}

\begin{proof}\leanok
\uses{lem:rnDeriv_map_eq_condexp}
TODO: the current Lean proof is not the proof presented here (but a direct computation).

The restriction $\mu_{| \mathcal A}$ is the map of $\mu$ by the identity, seen as a function from $\mathcal X$ with its $\sigma$-algebra to $\mathcal X$ with $\mathcal{A}$.
We can thus apply Lemma~\ref{lem:rnDeriv_map_eq_condexp}.
\end{proof}


\begin{lemma}
  \label{lem:rnDeriv_map_eq_rnDeriv_trim}
  %\lean{}
  %\leanok
  \uses{}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ with $\mu \ll \nu$, $g : \mathcal X \to \mathcal Y$ a measurable function and denote by $g^* \mathcal Y$ the comap of the $\sigma$-algebra on $\mathcal Y$ by $g$.
  Then $\nu$-almost everywhere,
  \begin{align*}
  \frac{d g_*\mu}{d g_*\nu}(g(x)) = \frac{d \mu_{| g^* \mathcal Y}}{d \nu_{| g^* \mathcal Y}}(x)
  \: .
  \end{align*}
\end{lemma}

\begin{proof}%\leanok
\uses{lem:rnDeriv_map_eq_condexp, lem:rnDeriv_trim_of_ac}
Combine Lemma~\ref{lem:rnDeriv_map_eq_condexp} and Lemma~\ref{lem:rnDeriv_trim_of_ac}.
\end{proof}