\chapter{Radon-Nikodym derivatives and disintegration}

\begin{definition}
  \label{def:kernel_rnDeriv}
  \lean{ProbabilityTheory.Kernel.rnDeriv}
  \leanok
  \uses{lem:kernel_properties}
  Let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels. The Radon-Nikodym derivative of $\kappa$ with respect to $\eta$, denoted by $\frac{d \kappa}{d \eta}$, is a measurable function $\mathcal X \times \mathcal Y \to \mathbb{R}_{+, \infty}$ with $\kappa = \frac{d \kappa}{d \eta} \cdot \eta + \kappa_{\perp \eta}$, where for all $x$, $\kappa_{\perp \eta}(x) \perp \eta(x)$.
\end{definition}

\begin{lemma}
  \label{lem:rnDeriv_unique}
  \lean{ProbabilityTheory.Kernel.eq_rnDeriv_measure}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels. If for some $f$ and $\xi$, $\kappa = f \cdot \eta + \xi$ with $\xi(x) \perp \eta(x)$ for all $x$, then for all $x$, $f(x, y) = \frac{d \kappa(x)}{d \eta(x)}(y)$ for $\eta(x)$-almost all $y \in \mathcal Y$.
\end{lemma}

\begin{proof} \leanok
Let $f$ and $\xi$ be such that $\kappa = f \cdot \eta + \xi$ with $\xi(x) \perp \eta(x)$ for all $x$. Then for all $x \in \mathcal X$, $\kappa(x) = f(x, \cdot) \cdot \eta(x) + \xi(x)$ with $\xi(x) \perp \eta(x)$. By the uniqueness result for the Radon-Nikodym derivative of measures, $f(x, \cdot) = \frac{d \kappa(x)}{d \eta(x)}$ almost everywhere.
\end{proof}

\begin{corollary}
  \label{cor:rnDeriv_value}
  \lean{ProbabilityTheory.Kernel.rnDeriv_eq_rnDeriv_measure}
  \leanok
  \uses{def:kernel_rnDeriv}
  For all $x \in \mathcal X$, for $\eta(x)$-almost all $y \in \mathcal Y$, $\frac{d \kappa}{d \eta}(x, y) = \frac{d \kappa(x)}{d \eta(x)}(y)$.
\end{corollary}

\begin{proof} \leanok
\uses{lem:rnDeriv_unique}
Apply Lemma~\ref{lem:rnDeriv_unique}.
\end{proof}



\section{Composition-product}

\begin{lemma}
  \label{lem:rnDeriv_compProd_aux}
  \lean{ProbabilityTheory.Kernel.rnDeriv_measure_compProd_aux}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu, \nu$ be two measures on $\mathcal X$ with $\mu \ll \nu$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels with $\kappa(x) \ll \eta(x)$ for $\nu$-almost all $x$. Then for $(\nu \otimes \eta)$-almost all $(x, y)$, $\frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)}(x,y) = \frac{d\mu}{d\nu}(x)\frac{d \kappa}{d \eta}(x,y)$.
  This implies that the equality is true for $\nu$-almost all $x$, for $\eta(x)$-almost all $y$.
\end{lemma}

\begin{proof} \leanok
\uses{cor:rnDeriv_value}
It is sufficient to prove that the integrals of the two functions on all product sets $s \times t$ for $s$ and $t$ measurable are equal (since these sets are a $\pi$-system). The computation of first integral is immediate :
\begin{align*}
\int_{p \in s \times t}\frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)}(p) \partial(\nu \otimes \eta)
&= (\mu \otimes \kappa)(s \times t)
\: .
\end{align*}
The second one uses Corollary~\ref{cor:rnDeriv_value}.
\begin{align*}
\int_{p \in s \times t}\frac{d\mu}{d\nu}(p_X) \frac{d \kappa}{d \eta}(p) \partial(\nu \otimes \eta)
&= \int_{x \in s} \int_{y \in t} \frac{d\mu}{d\nu}(x) \frac{d \kappa}{d \eta}(x,y) \partial\eta(x) \partial\nu
\\
&= \int_{x \in s} \frac{d\mu}{d\nu}(x) \int_{y \in t} \frac{d \kappa(x)}{d \eta(x)}(y) \partial\eta(x) \partial\nu
\\
&= \int_{x \in s} \frac{d\mu}{d\nu}(x) \kappa(x)(t) \partial\nu
\\
&= \int_{x \in s} \kappa(x)(t) \partial\mu
\\
&= (\mu \otimes \kappa)(s \times t)
\: .
\end{align*}
\end{proof}

\begin{lemma}
  \label{lem:rnDeriv_eq_ac}
  \lean{ProbabilityTheory.Kernel.todo1}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu, \nu$ be two measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels. Let $\mu' = \left(\frac{\partial \mu}{\partial \nu}\right) \cdot \nu$ and $\kappa' = \left(\frac{\partial \kappa}{\partial \eta}\right) \cdot \eta$. Then for $(\nu \otimes \eta)$-almost all $z$, $\frac{\partial(\mu' \otimes \kappa')}{\partial (\nu \otimes \eta)}(z) = \frac{\partial(\mu \otimes \kappa)}{\partial (\nu \otimes \eta)}(z)$.
\end{lemma}

\begin{proof} \leanok
\end{proof}

\begin{lemma}
  \label{lem:prod_rnDeriv_eq_ac}
  \lean{ProbabilityTheory.Kernel.todo2}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu, \nu$ be two measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels. Let $\mu' = \left(\frac{\partial \mu}{\partial \nu}\right) \cdot \nu$ and $\kappa' = \left(\frac{\partial \kappa}{\partial \eta}\right) \cdot \eta$. Then for $(\nu \otimes \eta)$-almost all $(x, y)$, $\frac{d\mu'}{d\nu}(x)\frac{d \kappa'}{d \eta}(x,y) = \frac{d\mu}{d\nu}(x)\frac{d \kappa}{d \eta}(x,y)$.
\end{lemma}

\begin{proof} \leanok
\end{proof}

\begin{lemma}
  \label{lem:rnDeriv_compProd}
  \lean{ProbabilityTheory.Kernel.rnDeriv_measure_compProd}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu, \nu$ be two measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels. Then for $(\nu \otimes \eta)$-almost all $(x, y)$, $\frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)}(x,y) = \frac{d\mu}{d\nu}(x)\frac{d \kappa}{d \eta}(x,y)$.
  This implies that the equality is true for $\nu$-almost all $x$, for $\eta(x)$-almost all $y$.
\end{lemma}

\begin{proof} \leanok
\uses{lem:rnDeriv_compProd_aux, lem:rnDeriv_eq_ac, lem:prod_rnDeriv_eq_ac}
Use Lemma~\ref{lem:rnDeriv_eq_ac} for $\mu', \kappa'$ (defined in previous lemmas) then \ref{lem:rnDeriv_compProd_aux} and \ref{lem:prod_rnDeriv_eq_ac}.
\end{proof}


\begin{lemma}
  \label{cor:rnDeriv_compProd_left}
  \lean{ProbabilityTheory.Kernel.rnDeriv_measure_compProd_left}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ and let $\kappa : \mathcal X \rightsquigarrow \mathcal Y$ be a finite kernel. Then for $(\nu \otimes \kappa)$-almost all $(x, y)$, $\frac{d (\mu \otimes \kappa)}{d (\nu \otimes \kappa)}(x,y) = \frac{d\mu}{d\nu}(x)$.
\end{lemma}

\begin{proof} \leanok
\uses{lem:rnDeriv_compProd}
TODO: wlog $\mu \ll \nu$, and we can consider products of sets.
\begin{align*}
\int_{p \in s \times t} \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \kappa)}(p) \partial(\nu \otimes \kappa)
&= (\mu \otimes \kappa) (s \times t)
\: .
\end{align*}

\begin{align*}
\int_{p \in s \times t} \frac{d \mu}{d \nu}(p_1) \partial(\nu \otimes \kappa)
&= \int_{x \in s} \int_{y \in t} \frac{d \mu}{d \nu}(x) \partial \kappa(x) \partial \nu
\\
&= \int_{x \in s} \frac{d \mu}{d \nu}(x) \kappa(x)(t) \partial \nu
\\
&= \int_{x \in s} \kappa(x)(t) \partial \mu
\\
&= (\mu \otimes \kappa) (s \times t)
\: .
\end{align*}


\end{proof}

\begin{corollary}
  \label{cor:rnDeriv_compProd_right}
  \lean{ProbabilityTheory.Kernel.rnDeriv_measure_compProd_right}
  \leanok
  \uses{def:kernel_rnDeriv}
  Let $\mu$ be a measures on $\mathcal X$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be two finite kernels. Then for $(\mu \otimes \eta)$-almost all $(x, y)$, $\frac{d (\mu \otimes \kappa)}{d (\mu \otimes \eta)}(x,y) = \frac{d \kappa}{d \eta}(x,y)$.
\end{corollary}

\begin{proof} \leanok
\uses{lem:rnDeriv_compProd}
\end{proof}



\section{Composition}


\begin{lemma}
  \label{lem:rnDeriv_map_eq_condexp}
  %\lean{}
  %\leanok
  \uses{}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ with $\mu \ll \nu$, $g : \mathcal X \to \mathcal Y$ a measurable function and denote by $g^* \mathcal Y$ the comap of the $\sigma$-algebra on $\mathcal Y$ by $g$.
  Then $\nu$-almost everywhere,
  \begin{align*}
  \frac{d g_*\mu}{d g_*\nu}(g(x)) = \nu\left[ \frac{d \mu}{d \nu} \mid g^* \mathcal Y\right](x)
  \: .
  \end{align*}
\end{lemma}

\begin{proof}%\leanok
\uses{}
We show that the integrals of the two functions agree on all $g^* \mathcal Y$-measurable sets. It suffices to show equality on all sets oc $\mathcal X$ of the form $g^{-1}(t)$ for $t$ a measurable set of $\mathcal Y$.
TODO: also show measurability.
\begin{align*}
\int_{x \in g^{-1}(t)}\frac{d g_*\mu}{d g_*\nu}(g(x)) \partial\nu
&= \int_{y \in t}\frac{d g_*\mu}{d g_*\nu}(y) \partial(g_*\nu)
\\
&= g_*\mu (t)
\: .
\end{align*}

\begin{align*}
\int_{x \in g^{-1}(t)}\nu\left[ \frac{d \mu}{d \nu} \mid g^* \mathcal Y\right](x) \partial\nu
&= \int_{x \in g^{-1}(t)}\frac{d \mu}{d \nu}(x) \partial\nu
\\
&= \mu(g^{-1}(t))
\\
&= g_*\mu(t)
\: .
\end{align*}


\end{proof}


\begin{lemma}
  \label{lem:rnDeriv_comp_eq_condexp}
  %\lean{}
  %\leanok
  \uses{}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ with $\mu \ll \nu$ and let $\kappa, \eta : \mathcal X \rightsquigarrow \mathcal Y$ be a s-finite kernels with $\kappa(x) \ll \eta(x)$ $\nu$-a.e..
  Let $\mathcal B$ be the sigma-algebra on $\mathcal X \times \mathcal Y$ obtained by taking the comap of the sigma-algebra of $\mathcal Y$ by the projection.
  Then for $(\nu \otimes \eta)$-almost every $(x,y)$,
  \begin{align*}
  \frac{d(\kappa \circ \mu)}{d(\eta \circ \nu)}(y)
  &= (\nu \otimes \eta)\left[ \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)} \Big| \mathcal B \right](x,y)
  \: .
  \end{align*}
\end{lemma}

\begin{proof}%\leanok
\uses{lem:rnDeriv_map_eq_condexp}
Let $\pi_Y : \mathcal X \times \mathcal Y \to \mathcal Y$ be the projection $\pi_Y(x,y) = y$.
Remark that $\kappa \circ \mu = \pi_{Y*}(\mu \otimes \kappa)$ and similarly for $\nu, \eta$.
By Lemma~\ref{lem:rnDeriv_map_eq_condexp}, $(\nu \otimes \eta)$-almost everywhere,
\begin{align*}
\frac{d(\kappa \circ \mu)}{d(\eta \circ \nu)}(y)
&= \frac{d \pi_{Y*}(\mu \otimes \kappa)}{d \pi_{Y*}(\nu \otimes \eta)}(\pi_Y((x,y)))
\\
&= (\nu \otimes \eta)\left[ \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \eta)} \mid \mathcal B\right](x,y)
\: .
\end{align*}
\end{proof}


\begin{lemma}[\cite{csiszar1963informationstheoretische}]
  \label{lem:rnDeriv_comp_eq_condexp_right}
  %\lean{}
  %\leanok
  \uses{}
  Let $\mu, \nu \in \mathcal M(\mathcal X)$ with $\mu \ll \nu$ and let $\kappa : \mathcal X \rightsquigarrow \mathcal Y$ be a finite kernel.
  Let $\mathcal B$ be the sigma-algebra on $\mathcal X \times \mathcal Y$ obtained by taking the comap of the sigma-algebra of $\mathcal Y$ by the projection.
  Then for $(\nu \otimes \kappa)$-almost every $(x,y)$,
  \begin{align*}
  \frac{d(\kappa \circ \mu)}{d(\kappa \circ \nu)}(y)
  &= (\nu \otimes \kappa)\left[ (x, y) \mapsto \frac{d \mu}{d \nu}(x) \Big| \mathcal B \right](x,y)
  \: .
  \end{align*}
  
\end{lemma}

\begin{proof}%\leanok
\uses{lem:rnDeriv_comp_eq_condexp,cor:rnDeriv_compProd_left}
Apply Lemma~\ref{lem:rnDeriv_comp_eq_condexp} to get, $(\nu \otimes \kappa)$-almost everywhere,
\begin{align*}
\frac{d(\kappa \circ \mu)}{d(\kappa \circ \nu)}(y)
&= (\nu \otimes \kappa)\left[ \frac{d (\mu \otimes \kappa)}{d (\nu \otimes \kappa)} \mid \mathcal B\right](x,y)
\: .
\end{align*}
Finally, by Corollary~\ref{cor:rnDeriv_compProd_left}, $\frac{d (\mu \otimes \kappa)}{d (\nu \otimes \kappa)} = \frac{d \mu}{d \nu}$ a.e.
\end{proof}